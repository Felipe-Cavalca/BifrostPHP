name: Merge Main to Latest-Release on Release Update

on:
  release:
    types:
      - published
      - edited

jobs:
  update_latest_release_branch:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Get release info
      id: get_release
      run: |
        echo "RELEASE_ID=$(jq -r .release.id "$GITHUB_EVENT_PATH")" >> $GITHUB_ENV
        echo "IS_LATEST=$(jq -r .release.tag_name "$GITHUB_EVENT_PATH" | grep -c 'latest')" >> $GITHUB_ENV

    - name: Merge Main into Latest-Release
      if: env.IS_LATEST == '1'
      env:
        BRANCH_NAME: latest-release
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        git checkout main
        git pull origin main
        git checkout -b ${BRANCH_NAME} || git checkout ${BRANCH_NAME}
        git pull origin ${BRANCH_NAME}
        git merge main
        git push origin ${BRANCH_NAME}
